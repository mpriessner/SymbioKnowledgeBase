# Story 5.4: Implement Version History API

## Metadata
- **Epic:** Epic 5 â€” Living Documentation System
- **Points:** 5
- **Priority:** Medium
- **Status:** ðŸ”² Not Started

## Description
Create API endpoints for viewing document history and restoring previous versions.

## User Story
*As a user, I want to view document history so that I can understand how it evolved and restore previous versions.*

## Acceptance Criteria
- [ ] GET `/api/pages/[id]/history` endpoint (user API)
- [ ] GET `/api/agent/docs/[id]/history` endpoint (agent API)
- [ ] Returns list of versions with metadata
- [ ] GET `/api/pages/[id]/history/[version]` returns full content
- [ ] GET `/api/pages/[id]/history/compare?v1=X&v2=Y` returns diff
- [ ] UI component to browse history timeline
- [ ] Restore button creates new version from old

## Technical Details

### API Response Format
```typescript
// GET /api/pages/{id}/history
{
  "versions": [
    {
      "version": 5,
      "createdAt": "2026-02-24T10:30:00Z",
      "changeType": "MANUAL",
      "changeSource": "user-uuid",
      "changeNotes": "Updated reagent concentrations",
      "wordCount": 450
    },
    {
      "version": 4,
      "createdAt": "2026-02-23T14:15:00Z",
      "changeType": "PROPAGATED",
      "changeSource": "page-uuid",
      "changeNotes": null,
      "wordCount": 420
    }
  ],
  "totalVersions": 5,
  "currentVersion": 5
}

// GET /api/pages/{id}/history/{version}
{
  "version": 4,
  "content": { /* TipTap JSON */ },
  "plainText": "...",
  "createdAt": "2026-02-23T14:15:00Z",
  "changeType": "PROPAGATED"
}

// GET /api/pages/{id}/history/compare?v1=4&v2=5
{
  "v1": 4,
  "v2": 5,
  "diff": {
    "additions": 3,
    "deletions": 1,
    "changes": [ /* structured diff */ ]
  }
}
```

### Restore Endpoint
```typescript
// POST /api/pages/{id}/history/{version}/restore
// Creates a new version with content from the specified version
```

## Dependencies
- Depends on: 5.1
- Blocks: 5.6 (diff visualization)

## Files to Create/Modify
- `src/app/api/pages/[id]/history/route.ts`
- `src/app/api/pages/[id]/history/[version]/route.ts`
- `src/app/api/pages/[id]/history/compare/route.ts`
- `src/app/api/agent/docs/[id]/history/route.ts`

## Testing
- Unit: Version queries
- Integration: Full history flow
- E2E: Restore functionality

## Complexity
**M (Medium)** â€” Multiple related endpoints
