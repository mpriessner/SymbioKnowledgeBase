# Story 1.3: Implement Single File Upload API

## Metadata
- **Epic:** Epic 1 â€” File Upload & Storage System
- **Points:** 5
- **Priority:** High
- **Status:** ðŸ”² Not Started

## Description
Create the core API endpoint for uploading a single file to a page with validation, storage, and metadata tracking.

## User Story
*As a user, I want to upload a single file to a page so that I can attach supporting documents to my notes.*

## Acceptance Criteria
- [ ] POST `/api/files/upload` accepts multipart form data
- [ ] Validates file type against allowlist
- [ ] Validates file size (max 100MB default)
- [ ] Creates FileAttachment record with UPLOADING status
- [ ] Uploads to Supabase Storage with correct path
- [ ] Updates status to READY on success
- [ ] Returns file metadata including storage URL
- [ ] Properly handles upload failures with cleanup
- [ ] Audit log entry created

## Technical Details

### API Endpoint
```typescript
// POST /api/files/upload
// Content-Type: multipart/form-data

// Request body:
// - file: File (required)
// - pageId: string (optional)
// - blockId: string (optional)

// Response (200 OK):
{
  "id": "uuid",
  "filename": "experiment-data.xlsx",
  "mimeType": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
  "size": 45678,
  "status": "READY",
  "url": "https://storage.supabase.co/...",
  "createdAt": "2026-02-24T12:00:00Z"
}
```

### Allowed File Types
```typescript
const ALLOWED_MIME_TYPES = [
  'application/pdf',
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
  'application/vnd.ms-excel',
  'text/csv',
  'image/jpeg',
  'image/png',
  'image/webp',
  'video/mp4',
  'video/quicktime',
  'text/plain',
  'text/markdown',
  'application/json'
];
```

## Dependencies
- Depends on: 1.1, 1.2
- Blocks: 1.4, 1.5

## Files to Create/Modify
- `src/app/api/files/upload/route.ts`
- `src/lib/storage/supabaseStorage.ts`
- `src/lib/validation/fileUpload.ts`

## Testing
- Unit: Validation logic
- Integration: Full upload flow
- Error cases: Invalid type, size exceeded, storage failure

## Complexity
**M (Medium)** â€” Core functionality with error handling
