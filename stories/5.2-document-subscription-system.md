# Story 5.2: Implement Document Subscription System

## Metadata
- **Epic:** Epic 5 â€” Living Documentation System
- **Points:** 5
- **Priority:** High
- **Status:** ðŸ”² Not Started

## Description
Create a subscription system that allows pages to "watch" other pages or external URLs for changes.

## User Story
*As an agent, I want to subscribe to document changes so that I can trigger updates when upstream docs change.*

## Acceptance Criteria
- [ ] DocumentSubscription model created
- [ ] Subscribe: page watches external URL or other page
- [ ] Subscription types: MIRROR, NOTIFY, SUGGEST
- [ ] Store: sourceType (url, page, machine), sourceId, checkInterval
- [ ] POST `/api/agent/docs/subscribe` endpoint
- [ ] GET `/api/agent/docs/[id]/subscriptions` endpoint
- [ ] DELETE `/api/agent/docs/subscriptions/[id]` endpoint

## Technical Details

### Prisma Schema
```prisma
model DocumentSubscription {
  id            String               @id @default(uuid())
  pageId        String               @map("page_id")
  tenantId      String               @map("tenant_id")
  sourceType    SourceType
  sourceId      String               @map("source_id") // URL or pageId
  behavior      SubscriptionBehavior
  checkInterval Int                  @default(86400) @map("check_interval") // seconds
  lastCheckedAt DateTime?            @map("last_checked_at")
  lastHash      String?              @map("last_hash") // For change detection
  isActive      Boolean              @default(true) @map("is_active")
  createdAt     DateTime             @default(now()) @map("created_at")
  
  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  page          Page                 @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, pageId])
  @@index([tenantId, isActive])
  @@map("document_subscriptions")
}

enum SourceType {
  URL
  PAGE
  MACHINE_PROTOCOL
}

enum SubscriptionBehavior {
  MIRROR      // Auto-replace content
  NOTIFY      // Notify subscribers of change
  SUGGEST     // Create suggested update for review
}
```

### API Endpoints
```typescript
// POST /api/agent/docs/subscribe
{
  "page_id": "uuid",
  "source_type": "PAGE" | "URL" | "MACHINE_PROTOCOL",
  "source_id": "uuid or url",
  "behavior": "MIRROR" | "NOTIFY" | "SUGGEST",
  "check_interval": 86400
}

// GET /api/agent/docs/{id}/subscriptions
// DELETE /api/agent/docs/subscriptions/{id}
```

## Dependencies
- Depends on: 5.1
- Blocks: 5.3, 5.5

## Files to Create/Modify
- `prisma/schema.prisma`
- `src/app/api/agent/docs/subscribe/route.ts`
- `src/app/api/agent/docs/[id]/subscriptions/route.ts`
- `src/app/api/agent/docs/subscriptions/[id]/route.ts`

## Testing
- Unit: Subscription CRUD
- Integration: API endpoint tests

## Complexity
**M (Medium)** â€” Multiple endpoints + schema
