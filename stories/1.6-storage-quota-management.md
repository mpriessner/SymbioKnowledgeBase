# Story 1.6: Implement Storage Quota Management

## Metadata
- **Epic:** Epic 1 â€” File Upload & Storage System
- **Points:** 5
- **Priority:** Low
- **Status:** ðŸ”² Not Started

## Description
Add storage usage tracking and quota enforcement to manage tenant storage consumption.

## User Story
*As a tenant admin, I want to see and manage storage usage so that I can plan for capacity and control costs.*

## Acceptance Criteria
- [ ] Dashboard shows total storage used by tenant
- [ ] Breakdown by file type (PDF, images, etc.)
- [ ] Breakdown by user
- [ ] Warning at 80% quota usage
- [ ] Uploads blocked at 100% quota (configurable)
- [ ] API to query storage usage
- [ ] Ability to set per-user quotas (optional)

## Technical Details

### Tenant Model Extension
```prisma
model Tenant {
  // ... existing fields
  storageQuotaBytes  BigInt   @default(5368709120) @map("storage_quota_bytes") // 5GB default
  storageUsedBytes   BigInt   @default(0) @map("storage_used_bytes")
}
```

### API Endpoints
```typescript
// GET /api/files/quota
{
  "quotaBytes": 5368709120,
  "usedBytes": 1234567890,
  "usedPercentage": 23,
  "breakdown": {
    "pdf": 500000000,
    "images": 300000000,
    "spreadsheets": 200000000,
    "other": 234567890
  }
}

// GET /api/files/quota/by-user
{
  "users": [
    { "userId": "...", "name": "Martin", "usedBytes": 800000000 },
    { "userId": "...", "name": "Lisa", "usedBytes": 434567890 }
  ]
}
```

### Quota Enforcement
```typescript
// In upload handler:
async function checkQuota(tenantId: string, fileSize: number): Promise<boolean> {
  const tenant = await prisma.tenant.findUnique({
    where: { id: tenantId },
    select: { storageQuotaBytes: true, storageUsedBytes: true }
  });
  
  return (tenant.storageUsedBytes + fileSize) <= tenant.storageQuotaBytes;
}
```

## Dependencies
- Depends on: 1.1, 1.3
- Blocks: None

## Files to Create/Modify
- `prisma/schema.prisma` (extend Tenant)
- `src/app/api/files/quota/route.ts`
- `src/components/dashboard/StorageUsageCard.tsx`
- `src/lib/storage/quotaService.ts`

## Testing
- Unit: Quota calculation
- Integration: Upload blocked at quota
- UI: Usage display accuracy

## Complexity
**M (Medium)** â€” Aggregation queries + UI
