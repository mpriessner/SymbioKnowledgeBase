# Story SKB-22.1: Heading Extraction & Scroll Spy Hook

**Epic:** Epic 22 - Table of Contents & Scroll Spy Navigation
**Story ID:** SKB-22.1
**Story Points:** 5 | **Priority:** High | **Status:** Draft
**Depends On:** EPIC-04 (TipTap BlockEditor must be working)

---

## User Story

As a developer building the Table of Contents feature, I need a reactive hook that extracts headings from the TipTap editor content and tracks which heading is currently visible in the viewport, So that the indicator bars and TOC panel can render accurate, real-time navigation data.

---

## Acceptance Criteria

### Heading Extraction
- [ ] `useTableOfContents(editor)` hook accepts a TipTap `Editor` instance
- [ ] Returns a `headings` array: `{ id: string, text: string, level: 1|2|3, element: HTMLElement | null }[]`
- [ ] Headings are extracted from the editor's current content whenever it changes
- [ ] Extraction is debounced (200ms) to avoid excessive re-computation during typing
- [ ] Empty headings (no text content) are excluded from the list
- [ ] Heading order matches document order (top to bottom)
- [ ] Returns an empty array if the editor has no headings

### Stable Anchor IDs
- [ ] Each heading DOM element gets a stable `id` attribute (e.g., `heading-introduction`, `heading-overview`)
- [ ] IDs are generated by slugifying the heading text: lowercase, spaces → hyphens, strip special characters
- [ ] Duplicate heading texts get a numeric suffix: `heading-overview`, `heading-overview-2`, `heading-overview-3`
- [ ] IDs remain stable across re-renders as long as heading text doesn't change
- [ ] IDs are applied via a TipTap extension or plugin that decorates heading nodes with `id` attributes
- [ ] The `id` attribute enables `element.scrollIntoView()` and URL hash navigation (`#heading-overview`)

### Scroll Spy (Active Heading Detection)
- [ ] Hook returns `activeHeadingId: string | null` — the ID of the heading currently in or nearest above the viewport top
- [ ] Uses `IntersectionObserver` to track which headings enter/leave the viewport
- [ ] When multiple headings are visible, the topmost one (closest to viewport top) is active
- [ ] When no headings are visible (scrolled between headings), the last heading scrolled past is active
- [ ] Scrolling down through a heading → it becomes active when its top edge crosses ~20% from the viewport top
- [ ] Scrolling up → the heading above becomes active when the current heading's top edge goes below ~20%
- [ ] Active heading updates are throttled (100ms) for smooth performance
- [ ] `activeHeadingId` is `null` when the page is scrolled above the first heading

### Scroll Container Awareness
- [ ] Hook accepts an optional `scrollContainerRef` for pages where the scroll container is not `window`
- [ ] In SymbioKnowledgeBase, the scroll container is the `.overflow-y-auto` div in the page view — not `window`
- [ ] IntersectionObserver's `root` option is set to the scroll container element
- [ ] Correctly handles the case where the scroll container is resized

### Editor Integration
- [ ] Hook subscribes to editor's `onUpdate` event for content changes
- [ ] Hook cleans up (disconnects IntersectionObserver, removes event listeners) on unmount
- [ ] Hook handles editor being `null` or `undefined` (returns empty state)
- [ ] Hook handles editor being destroyed (no errors thrown)

### Performance
- [ ] Heading extraction runs in O(n) where n = number of nodes (single pass through editor JSON)
- [ ] No DOM querying for heading extraction — uses TipTap's `editor.getJSON()` or ProseMirror doc traversal
- [ ] IntersectionObserver is created once and updated only when heading count changes
- [ ] Memory: no leaked observers or event listeners

---

## Architecture Overview

```
useTableOfContents Hook Architecture
──────────────────────────────────────

Input:
  editor: Editor (TipTap instance)
  scrollContainerRef: RefObject<HTMLElement>

Output:
  headings: TOCHeading[]         // Extracted heading list
  activeHeadingId: string | null // Currently visible heading

Internal Flow:
──────────────

┌───────────────────────────────────────────────────────────────┐
│  TipTap Editor                                                 │
│                                                                │
│  editor.on("update", callback)                                │
│  → debounce(200ms)                                            │
│  → extractHeadings(editor)                                    │
│      │                                                        │
│      │  Traverse editor.state.doc                             │
│      │  Find all nodes with type === "heading"                │
│      │  Extract: { text, level }                              │
│      │  Generate slugified IDs                                │
│      │  Handle duplicates with suffixes                       │
│      │                                                        │
│      ▼                                                        │
│  headings = [                                                 │
│    { id: "heading-introduction", text: "Introduction", level: 1 },
│    { id: "heading-overview", text: "Overview", level: 2 },   │
│    { id: "heading-details", text: "Details", level: 2 },     │
│    { id: "heading-sub-detail", text: "Sub-detail", level: 3 },
│  ]                                                            │
└───────────────────────────────────────────────────────────────┘
          │
          │ headings changed → update IntersectionObserver
          ▼
┌───────────────────────────────────────────────────────────────┐
│  IntersectionObserver                                          │
│                                                                │
│  root: scrollContainerRef.current                             │
│  rootMargin: "-20% 0px -80% 0px"                             │
│    (triggers when heading is in top 20% of viewport)          │
│  threshold: [0, 1]                                            │
│                                                                │
│  Observes: all heading DOM elements (by ID)                   │
│                                                                │
│  On intersection change:                                      │
│    → Find topmost intersecting heading                        │
│    → Set activeHeadingId                                      │
│    → If none intersecting, use last heading above viewport    │
└───────────────────────────────────────────────────────────────┘

Anchor ID Generation:
─────────────────────

  "Key Takeaways for SciSymbioAI"  → "heading-key-takeaways-for-scisymbioai"
  "Immediate Deadlines (Jan-Mar)"  → "heading-immediate-deadlines-jan-mar"
  "Overview"                        → "heading-overview"
  "Overview" (duplicate)            → "heading-overview-2"
```

---

## Implementation Steps

### Step 1: Create Heading ID Slug Utility

**File: `src/lib/utils/slugify.ts`**

```typescript
/**
 * Convert heading text to a URL-safe anchor ID.
 * "Key Takeaways for SciSymbioAI" → "heading-key-takeaways-for-scisymbioai"
 */
export function slugifyHeading(text: string): string {
  return "heading-" + text
    .toLowerCase()
    .trim()
    .replace(/[^\w\s-]/g, "")    // Remove special chars
    .replace(/\s+/g, "-")         // Spaces → hyphens
    .replace(/-+/g, "-")          // Collapse multiple hyphens
    .replace(/^-|-$/g, "");       // Trim leading/trailing hyphens
}

/**
 * Deduplicate heading IDs by adding numeric suffixes.
 */
export function deduplicateIds(ids: string[]): string[] {
  const counts = new Map<string, number>();
  return ids.map(id => {
    const count = counts.get(id) || 0;
    counts.set(id, count + 1);
    return count === 0 ? id : `${id}-${count + 1}`;
  });
}
```

### Step 2: Create Heading Extraction Function

**File: `src/hooks/useTableOfContents.ts`** (part 1)

```typescript
import { Editor } from "@tiptap/core";

export interface TOCHeading {
  id: string;
  text: string;
  level: 1 | 2 | 3;
  element: HTMLElement | null;
}

function extractHeadings(editor: Editor): TOCHeading[] {
  const headings: { text: string; level: 1 | 2 | 3 }[] = [];

  // Traverse ProseMirror document tree
  editor.state.doc.descendants((node) => {
    if (node.type.name === "heading" && node.textContent.trim()) {
      headings.push({
        text: node.textContent.trim(),
        level: node.attrs.level as 1 | 2 | 3,
      });
    }
  });

  // Generate and deduplicate IDs
  const rawIds = headings.map(h => slugifyHeading(h.text));
  const uniqueIds = deduplicateIds(rawIds);

  return headings.map((h, i) => ({
    id: uniqueIds[i],
    text: h.text,
    level: h.level,
    element: null, // Populated after DOM rendering
  }));
}
```

### Step 3: Create TipTap Heading ID Extension

**File: `src/components/editor/extensions/headingId.ts`**

A TipTap extension (or ProseMirror plugin) that decorates heading DOM nodes with `id` attributes matching the slugified heading text. This ensures the DOM has anchor IDs for IntersectionObserver and scrollIntoView.

```typescript
import { Extension } from "@tiptap/core";
import { Plugin, PluginKey } from "@tiptap/pm/state";
import { Decoration, DecorationSet } from "@tiptap/pm/view";

export const HeadingIdExtension = Extension.create({
  name: "headingId",

  addProseMirrorPlugins() {
    return [
      new Plugin({
        key: new PluginKey("headingId"),
        props: {
          decorations(state) {
            const decorations: Decoration[] = [];
            const slugCounts = new Map<string, number>();

            state.doc.descendants((node, pos) => {
              if (node.type.name === "heading" && node.textContent.trim()) {
                const baseSlug = slugifyHeading(node.textContent.trim());
                const count = slugCounts.get(baseSlug) || 0;
                slugCounts.set(baseSlug, count + 1);
                const id = count === 0 ? baseSlug : `${baseSlug}-${count + 1}`;

                decorations.push(
                  Decoration.node(pos, pos + node.nodeSize, { id })
                );
              }
            });

            return DecorationSet.create(state.doc, decorations);
          },
        },
      }),
    ];
  },
});
```

### Step 4: Create Scroll Spy Logic

**File: `src/hooks/useTableOfContents.ts`** (part 2)

```typescript
export function useTableOfContents(
  editor: Editor | null,
  scrollContainerRef: React.RefObject<HTMLElement>
): { headings: TOCHeading[]; activeHeadingId: string | null } {
  const [headings, setHeadings] = useState<TOCHeading[]>([]);
  const [activeHeadingId, setActiveHeadingId] = useState<string | null>(null);
  const observerRef = useRef<IntersectionObserver | null>(null);

  // 1. Extract headings on editor content change (debounced)
  useEffect(() => {
    if (!editor) return;
    const handler = debounce(() => {
      const extracted = extractHeadings(editor);
      setHeadings(extracted);
    }, 200);
    editor.on("update", handler);
    handler(); // Initial extraction
    return () => { editor.off("update", handler); handler.cancel(); };
  }, [editor]);

  // 2. Set up IntersectionObserver for scroll spy
  useEffect(() => {
    if (headings.length === 0 || !scrollContainerRef.current) return;

    // Disconnect previous observer
    observerRef.current?.disconnect();

    const visibleIds = new Set<string>();

    observerRef.current = new IntersectionObserver(
      (entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            visibleIds.add(entry.target.id);
          } else {
            visibleIds.delete(entry.target.id);
          }
        });

        // Find topmost visible heading
        if (visibleIds.size > 0) {
          const topmost = headings.find(h => visibleIds.has(h.id));
          if (topmost) setActiveHeadingId(topmost.id);
        }
        // If none visible, keep the last active (scrolled past)
      },
      {
        root: scrollContainerRef.current,
        rootMargin: "-20% 0px -80% 0px",
        threshold: [0, 1],
      }
    );

    // Observe all heading elements
    headings.forEach(h => {
      const el = document.getElementById(h.id);
      if (el) observerRef.current!.observe(el);
    });

    return () => { observerRef.current?.disconnect(); };
  }, [headings, scrollContainerRef]);

  return { headings, activeHeadingId };
}
```

### Step 5: Register HeadingId Extension in Editor Config

**File: `src/components/editor/editorConfig.ts`** (modify)

Add `HeadingIdExtension` to the extensions array so heading DOM elements get `id` attributes.

### Step 6: Add scroll-margin-top to Headings

**File: `src/components/editor/editor.css`** (modify)

```css
/* Offset for sticky header when scrolling to anchor */
.tiptap h1[id],
.tiptap h2[id],
.tiptap h3[id] {
  scroll-margin-top: 80px;
}
```

---

## Testing Requirements

### Unit Tests (20+ cases)

**File: `src/__tests__/lib/utils/slugify.test.ts`**

- `slugifyHeading("Introduction")` → `"heading-introduction"`
- `slugifyHeading("Key Takeaways for SciSymbioAI")` → `"heading-key-takeaways-for-scisymbioai"`
- `slugifyHeading("Immediate Deadlines (Jan-Mar 2026)")` → `"heading-immediate-deadlines-jan-mar-2026"`
- `slugifyHeading("  Extra  Spaces  ")` → `"heading-extra-spaces"`
- `slugifyHeading("Special!@#$%Characters")` → `"heading-specialcharacters"`
- `slugifyHeading("")` → `"heading-"` (or empty string — handled by filter)
- `deduplicateIds(["a", "b", "a", "a"])` → `["a", "b", "a-2", "a-3"]`
- `deduplicateIds(["x"])` → `["x"]`
- `deduplicateIds([])` → `[]`

**File: `src/__tests__/hooks/useTableOfContents.test.ts`**

- Returns empty headings array when editor is null
- Returns empty headings array when editor has no headings
- Extracts H1, H2, H3 headings with correct text and level
- Excludes empty headings (no text)
- Headings are in document order
- Heading IDs are slugified correctly
- Duplicate heading texts get numeric suffixes
- Headings update when editor content changes (debounced)
- activeHeadingId is null when no headings exist
- activeHeadingId updates when a heading enters the viewport
- activeHeadingId stays on last passed heading when between headings
- Cleanup: IntersectionObserver disconnected on unmount
- Cleanup: editor event listener removed on unmount

**File: `src/__tests__/components/editor/extensions/headingId.test.ts`**

- Heading node gets `id` attribute matching slugified text
- Multiple headings get unique IDs
- Duplicate headings get suffixed IDs
- Non-heading nodes don't get IDs
- IDs update when heading text changes

### Integration Tests (8+ cases)

**File: `src/__tests__/integration/table-of-contents-hook.test.tsx`**

- Render BlockEditor with 5 headings → hook returns 5 headings
- Headings have correct level (H1=1, H2=2, H3=3)
- Heading DOM elements have correct `id` attributes
- Scroll to H3 → activeHeadingId updates to H3's ID
- Scroll back to top → activeHeadingId is first heading
- Add new heading in editor → headings array updates
- Remove heading in editor → headings array updates
- Editor with no headings → empty array, null active

### E2E Tests (3+ cases)

**File: `src/__tests__/e2e/table-of-contents-hook.test.ts`**

- Page with headings → heading DOM elements have `id` attributes
- Scroll page → activeHeadingId changes as headings pass viewport
- Navigate to `#heading-overview` → page scrolls to that heading

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/hooks/useTableOfContents.ts` | Create | Main hook: heading extraction + scroll spy |
| `src/lib/utils/slugify.ts` | Create | Heading text to anchor ID slug utility |
| `src/components/editor/extensions/headingId.ts` | Create | TipTap extension to add `id` attrs to heading DOM |
| `src/components/editor/editorConfig.ts` | Modify | Register HeadingIdExtension |
| `src/components/editor/editor.css` | Modify | Add `scroll-margin-top` for heading anchors |
| `src/__tests__/lib/utils/slugify.test.ts` | Create | Slugify utility tests |
| `src/__tests__/hooks/useTableOfContents.test.ts` | Create | Hook unit tests |
| `src/__tests__/components/editor/extensions/headingId.test.ts` | Create | Extension tests |
| `src/__tests__/integration/table-of-contents-hook.test.tsx` | Create | Integration tests |
| `src/__tests__/e2e/table-of-contents-hook.test.ts` | Create | E2E tests |

---

**Last Updated:** 2026-02-25
