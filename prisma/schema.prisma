// SymbioKnowledgeBase — Prisma Schema
// All tables have tenant_id with composite indexes for multi-tenant isolation.

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────────────────

enum Role {
  ADMIN
  USER
}

enum TeamspaceRole {
  OWNER
  ADMIN
  MEMBER
  GUEST
}

enum BlockType {
  DOCUMENT
  PARAGRAPH
  HEADING_1
  HEADING_2
  HEADING_3
  BULLETED_LIST
  NUMBERED_LIST
  TODO
  TOGGLE
  CODE
  QUOTE
  CALLOUT
  DIVIDER
  IMAGE
  BOOKMARK
  TABLE
  FILE
}

enum NotificationType {
  PAGE_MENTION
  PAGE_UPDATE
  AGENT_CREATED
  SYSTEM
}

enum FileStatus {
  UPLOADING
  PROCESSING
  READY
  FAILED
}

enum SpaceType {
  PRIVATE
  TEAM
  AGENT
}

enum ChangeType {
  MANUAL
  AUTO_SYNC
  PROPAGATED
  MACHINE_UPDATE
  AI_SUGGESTED
}

enum SourceType {
  URL
  PAGE
  MACHINE_PROTOCOL
}

enum SubscriptionBehavior {
  MIRROR
  NOTIFY
  SUGGEST
}

// ─── Tenants ─────────────────────────────────────────────────────────

model Tenant {
  id           String   @id @default(uuid())
  name         String
  storageQuota BigInt   @default(5368709120) @map("storage_quota")
  storageUsed  BigInt   @default(0) @map("storage_used")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  users                  User[]
  pages                  Page[]
  blocks                 Block[]
  pageLinks              PageLink[]
  apiKeys                ApiKey[]
  databases              Database[]
  dbRows                 DbRow[]
  teamspaces             Teamspace[]
  publicShareLinks       PublicShareLink[]
  presenceRecords        PagePresence[]
  notifications          Notification[]
  auditLogs              AuditLog[]
  documentVersions       DocumentVersion[]
  documentSubscriptions  DocumentSubscription[]
  fileAttachments        FileAttachment[]

  @@map("tenants")
}

// ─── Users ───────────────────────────────────────────────────────────

model User {
  id           String   @id // Supabase auth.users.id (UUID) — no @default for Supabase-managed IDs
  tenantId     String   @map("tenant_id")
  email        String
  passwordHash String?  @map("password_hash") // Deprecated — managed by Supabase Auth
  role         Role     @default(USER)
  name         String?
  avatarUrl    String?  @map("avatar_url")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deactivatedAt  DateTime? @map("deactivated_at")

  // Relations
  tenant                Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  apiKeys               ApiKey[]
  teamspaceMemberships  TeamspaceMember[]
  createdShareLinks     PublicShareLink[]
  presenceRecords       PagePresence[]
  receivedNotifications Notification[]     @relation("NotificationRecipient")
  sentNotifications     Notification[]     @relation("NotificationSource")
  auditLogs             AuditLog[]
  fileAttachments       FileAttachment[]

  // Indexes
  @@unique([tenantId, email], map: "uq_users_email_tenant_id")
  @@index([tenantId, id], map: "idx_users_tenant_id_id")
  @@index([tenantId], map: "idx_users_tenant_id")

  @@map("users")
}

// ─── Pages ───────────────────────────────────────────────────────────

model Page {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  parentId     String?  @map("parent_id")
  teamspaceId  String?  @map("teamspace_id")
  title        String   @default("Untitled")
  icon         String?
  coverUrl     String?   @map("cover_url")
  position     Int       @default(0)
  spaceType    SpaceType @default(PRIVATE) @map("space_type")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  tenant       Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent       Page?       @relation("PageHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children     Page[]      @relation("PageHierarchy")
  teamspace             Teamspace?           @relation(fields: [teamspaceId], references: [id], onDelete: SetNull)
  blocks                Block[]
  sourceLinks           PageLink[]           @relation("SourcePage")
  targetLinks           PageLink[]           @relation("TargetPage")
  databases             Database[]
  dbRows                DbRow[]
  publicShareLinks      PublicShareLink[]
  presenceRecords       PagePresence[]
  notifications         Notification[]
  documentVersions      DocumentVersion[]
  documentSubscriptions DocumentSubscription[]
  fileAttachments       FileAttachment[]

  // Indexes
  @@index([tenantId, id], map: "idx_pages_tenant_id_id")
  @@index([tenantId], map: "idx_pages_tenant_id")
  @@index([tenantId, parentId], map: "idx_pages_tenant_id_parent_id")
  @@index([tenantId, teamspaceId], map: "idx_pages_tenant_id_teamspace_id")
  @@index([tenantId, spaceType], map: "idx_pages_tenant_id_space_type")

  @@map("pages")
}

// ─── Blocks ──────────────────────────────────────────────────────────

model Block {
  id        String    @id @default(uuid())
  pageId    String    @map("page_id")
  tenantId  String    @map("tenant_id")
  type      BlockType @default(PARAGRAPH)
  content      Json      @default("{}")
  position     Int       @default(0)
  plainText    String    @default("") @map("plain_text")
  searchVector Unsupported("tsvector")? @map("search_vector")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  page   Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId, id], map: "idx_blocks_tenant_id_id")
  @@index([tenantId], map: "idx_blocks_tenant_id")
  @@index([pageId], map: "idx_blocks_page_id")
  @@index([tenantId, pageId], map: "idx_blocks_tenant_id_page_id")

  @@map("blocks")
}

// ─── Page Links ──────────────────────────────────────────────────────

model PageLink {
  id           String   @id @default(uuid())
  sourcePageId String   @map("source_page_id")
  targetPageId String   @map("target_page_id")
  tenantId     String   @map("tenant_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  tenant     Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sourcePage Page   @relation("SourcePage", fields: [sourcePageId], references: [id], onDelete: Cascade)
  targetPage Page   @relation("TargetPage", fields: [targetPageId], references: [id], onDelete: Cascade)

  // Indexes
  @@unique([sourcePageId, targetPageId], map: "uq_page_links_source_target")
  @@index([tenantId, id], map: "idx_page_links_tenant_id_id")
  @@index([tenantId], map: "idx_page_links_tenant_id")
  @@index([tenantId, sourcePageId], map: "idx_page_links_tenant_id_source")
  @@index([tenantId, targetPageId], map: "idx_page_links_tenant_id_target")

  @@map("page_links")
}

// ─── API Keys ────────────────────────────────────────────────────────

model ApiKey {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  tenantId   String    @map("tenant_id")
  keyHash    String    @map("key_hash")
  keyPrefix  String    @map("key_prefix")
  name       String
  scopes     String[]  @default([])
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")
  revokedAt  DateTime? @map("revoked_at")

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  auditLogs AuditLog[]

  // Indexes
  @@index([tenantId, id], map: "idx_api_keys_tenant_id_id")
  @@index([tenantId], map: "idx_api_keys_tenant_id")
  @@index([keyHash], map: "idx_api_keys_key_hash")

  @@map("api_keys")
}

// ─── Databases (Notion-style typed tables) ───────────────────────────

model Database {
  id        String   @id @default(uuid())
  pageId    String   @map("page_id")
  tenantId  String   @map("tenant_id")
  schema    Json     @default("{}") @map("schema")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  page   Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)
  rows   DbRow[]

  // Indexes
  @@index([tenantId, id], map: "idx_databases_tenant_id_id")
  @@index([tenantId], map: "idx_databases_tenant_id")
  @@index([pageId], map: "idx_databases_page_id")

  @@map("databases")
}

// ─── Database Rows ───────────────────────────────────────────────────

model DbRow {
  id         String   @id @default(uuid())
  databaseId String   @map("database_id")
  pageId     String?  @map("page_id")
  tenantId   String   @map("tenant_id")
  properties Json     @default("{}") @map("properties")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  database Database @relation(fields: [databaseId], references: [id], onDelete: Cascade)
  page     Page?    @relation(fields: [pageId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([tenantId, id], map: "idx_db_rows_tenant_id_id")
  @@index([tenantId], map: "idx_db_rows_tenant_id")
  @@index([databaseId], map: "idx_db_rows_database_id")
  @@index([tenantId, databaseId], map: "idx_db_rows_tenant_id_database_id")

  @@map("db_rows")
}

// ─── Teamspaces ─────────────────────────────────────────────────

model Teamspace {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  name      String
  icon      String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  tenant  Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members TeamspaceMember[]
  pages   Page[]

  // Indexes
  @@unique([tenantId, name], map: "uq_teamspaces_tenant_name")
  @@index([tenantId], map: "idx_teamspaces_tenant_id")

  @@map("teamspaces")
}

model TeamspaceMember {
  id          String        @id @default(uuid())
  teamspaceId String        @map("teamspace_id")
  userId      String        @map("user_id")
  role        TeamspaceRole @default(MEMBER)
  createdAt   DateTime      @default(now()) @map("created_at")

  // Relations
  teamspace Teamspace @relation(fields: [teamspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@unique([teamspaceId, userId], map: "uq_teamspace_members_teamspace_user")
  @@index([teamspaceId, role], map: "idx_teamspace_members_teamspace_role")

  @@map("teamspace_members")
}

// ─── Public Share Links ─────────────────────────────────────────

model PublicShareLink {
  id        String    @id @default(uuid())
  pageId    String    @map("page_id")
  tenantId  String    @map("tenant_id")
  token     String    @unique
  createdBy String    @map("created_by")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  tenant        Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  page          Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)
  createdByUser User   @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  // Indexes
  @@index([token], map: "idx_public_share_links_token")
  @@index([pageId], map: "idx_public_share_links_page_id")

  @@map("public_share_links")
}

// ─── Page Presence ──────────────────────────────────────────────

model PagePresence {
  id            String   @id @default(uuid())
  pageId        String   @map("page_id")
  userId        String   @map("user_id")
  tenantId      String   @map("tenant_id")
  lastHeartbeat DateTime @default(now()) @map("last_heartbeat")
  isEditing     Boolean  @default(false) @map("is_editing")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  page   Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@unique([pageId, userId], map: "uq_page_presence_page_user")
  @@index([pageId], map: "idx_page_presence_page_id")
  @@index([lastHeartbeat], map: "idx_page_presence_last_heartbeat")

  @@map("page_presence")
}

// ─── Notifications ───────────────────────────────────────────────────

model Notification {
  id           String           @id @default(uuid())
  tenantId     String           @map("tenant_id")
  userId       String           @map("user_id")
  type         NotificationType
  title        String
  body         String?
  pageId       String?          @map("page_id")
  sourceUserId String?          @map("source_user_id")
  read         Boolean          @default(false)
  createdAt    DateTime         @default(now()) @map("created_at")

  // Relations
  tenant     Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User   @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  page       Page?  @relation(fields: [pageId], references: [id], onDelete: SetNull)
  sourceUser User?  @relation("NotificationSource", fields: [sourceUserId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([tenantId, userId, createdAt], map: "idx_notifications_user_created")
  @@index([tenantId, userId, read], map: "idx_notifications_user_read")

  @@map("notifications")
}

// ─── Document Versions ──────────────────────────────────────────────

model DocumentVersion {
  id           String     @id @default(uuid())
  pageId       String     @map("page_id")
  tenantId     String     @map("tenant_id")
  version      Int
  content      Json
  plainText    String     @map("plain_text")
  changeType   ChangeType @map("change_type")
  changeSource String?    @map("change_source")
  changeNotes  String?    @map("change_notes")
  diffFromPrev Json?      @map("diff_from_prev")
  createdAt    DateTime   @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  page   Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  // Indexes
  @@unique([pageId, version])
  @@index([pageId])
  @@index([tenantId, pageId])

  @@map("document_versions")
}

// ─── Document Subscriptions ─────────────────────────────────────────

model DocumentSubscription {
  id               String               @id @default(uuid())
  tenantId         String               @map("tenant_id")
  subscriberPageId String               @map("subscriber_page_id")
  sourceType       SourceType           @map("source_type")
  sourcePageId     String?              @map("source_page_id")
  sourceUrl        String?              @map("source_url")
  behavior         SubscriptionBehavior @default(NOTIFY)
  lastSyncedAt     DateTime?            @map("last_synced_at")
  lastSyncVersion  Int?                 @map("last_sync_version")
  isActive         Boolean              @default(true) @map("is_active")
  createdAt        DateTime             @default(now()) @map("created_at")
  updatedAt        DateTime             @updatedAt @map("updated_at")

  // Relations
  tenant         Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscriberPage Page   @relation(fields: [subscriberPageId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId, subscriberPageId])
  @@index([sourcePageId])

  @@map("document_subscriptions")
}

// ─── File Attachments ───────────────────────────────────────────────

model FileAttachment {
  id          String     @id @default(uuid())
  tenantId    String     @map("tenant_id")
  userId      String     @map("user_id")
  pageId      String?    @map("page_id")
  fileName    String     @map("file_name")
  fileSize    BigInt     @map("file_size")
  mimeType    String     @map("mime_type")
  storagePath String     @map("storage_path")
  storageUrl  String?    @map("storage_url")
  status      FileStatus @default(UPLOADING)
  checksum    String?
  metadata    Json?
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  page   Page?  @relation(fields: [pageId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([tenantId, pageId])
  @@index([tenantId, userId])

  @@map("file_attachments")
}

// ─── Audit Logs ─────────────────────────────────────────────────────

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  userId     String   @map("user_id")
  apiKeyId   String?  @map("api_key_id")
  action     String
  resource   String
  resourceId String?  @map("resource_id")
  details    Json?
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKey ApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([tenantId, createdAt], map: "idx_audit_logs_tenant_created")
  @@index([userId], map: "idx_audit_logs_user_id")
  @@index([resource, resourceId], map: "idx_audit_logs_resource")

  @@map("audit_logs")
}
